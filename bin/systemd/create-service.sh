#!/usr/bin/env bash


DAEMON_SYSTEMD_PATH="/etc/systemd/snap.${SNAPCRAFT_PROJECT_NAME}.daemon.service.d"
mkdir -p "${DAEMON_SYSTEMD_PATH}"

# We are copying the service conf file patch as editing the service file generated by snapd won't survive upgrades
copy set-limits.conf "${DAEMON_SYSTEMD_PATH}/override.conf"

# 1. Set the number of open file handles
ulimit -n 65535

# 1. permanently but also aggressive on the host conf files
# echo 'opensearch - nofile 65535' >> /etc/security/limits.conf

# 2. Allow the opensearch user to Disable all swap files:
swapoff -a

# 3. Ensuring sufficient virtual memory: https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html
sysctl -w vm.max_map_count=262144

# 3. permanently but also aggressive on the host conf files
# sed -i '/^vm.max_map_count=/{h;s/=.*/=262144/};${x;/^$/{s//vm.max_map_count=262144/;H};x}' /etc/sysctl.conf
# reload the conf
# sysctl -p

# 4. number of threads opensearch can create:
# should be configured automatically if opensearch ran as a service

# 4. or:
# ulimit -u 4096

# 4. permanently but also aggressive on the host conf files
# echo 'nproc' >> /etc/security/limits.conf

# 5. Reduce TCP retransmission timeout = ~6 seconds
sysctl -w net.ipv4.tcp_retries2=5

# 5. permanently but also aggressive on the host conf files
# add net.ipv4.tcp_retries2 to /etc/sysctl.conf
# try: sysctl net.ipv4.tcp_retries2
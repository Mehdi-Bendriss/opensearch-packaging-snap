name: opensearch # you probably want to 'snapcraft register <name>'
base: core20 # the base snap is the execution environment for this snap

version: '2.2.0' # just for humans, typically '1.2+git' or '1.3.2'

summary: 'OpenSearch: community-driven, Apache 2.0-licensed search and analytics suite.'
description: |
    OpenSearch is a community-driven, Apache 2.0-licensed open source search and 
    analytics suite that makes it easy to ingest, search, visualize, and analyze data. 
    Developers build with OpenSearch for use cases such as application search, 
    log analytics, data observability, data ingestion, and more.

grade: devel # must be 'stable' to release into candidate/stable channels

confinement: devmode # use 'strict' once you have the right plugs and slots

assumes:
  - command-chain
  - snap-env
  - snapd2.56

system-usernames:
  snap_daemon: shared

plugs:
  systemd-write:
    interface: system-files
    write:
      - /etc/systemd/system

hooks:
  install:
    plugs:
      - systemd-write
    environment:
      PROJECT_NAME: ${SNAPCRAFT_PROJECT_NAME}

  configure:
    plugs:
      - network
      - network-bind
    environment:
      PROJECT_NAME: ${SNAPCRAFT_PROJECT_NAME}
      PROJECT_VERSION: ${SNAPCRAFT_PROJECT_VERSION}

apps:
  daemon:
    daemon: simple
    install-mode: disable
    command: wrappers/start.sh
    reload-command: wrappers/start.sh
    plugs:
      - network
      - network-bind
      - systemd-write
    environment:
      OPENSEARCH_HOME: ${SNAP_DATA}
      OPENSEARCH_JAVA_HOME: ${SNAP_DATA}/jdk
      OPENSEARCH_PATH_CONF: ${SNAP_COMMON}/config
      OPENSEARCH_TMPDIR: ${SNAP_COMMON}/tmp
      PROJECT_NAME: ${SNAPCRAFT_PROJECT_NAME}
      PROJECT_VERSION: ${SNAPCRAFT_PROJECT_VERSION}

  add-plugin:
    command: wrappers/add-plugin.sh
    environment:
      OPENSEARCH_HOME: ${SNAP_DATA}
      PROJECT_NAME: ${SNAPCRAFT_PROJECT_NAME}

  list-plugins:
    command: wrappers/list-plugins.sh
    environment:
      OPENSEARCH_HOME: ${SNAP_DATA}
      PROJECT_NAME: ${SNAPCRAFT_PROJECT_NAME}


parts:
  wrapper-scripts:
    plugin: dump
    source: ./wrappers
    source-type: local
    organize:
      start.sh: wrappers/start.sh
      add-plugin.sh: wrappers/add-plugin.sh
      list-plugins.sh: wrappers/list-plugins.sh

  wrapper-configs:
    plugin: dump
    source: snap/local
    organize:
      systemd/override.conf: etc/systemd/override.conf

  opensearch:
    plugin: dump
    source: https://opensearch-builds.s3.eu-west-1.amazonaws.com/core/opensearch-$SNAPCRAFT_PROJECT_VERSION-linux.tar.gz
    source-type: tar
    stage-packages:
      - util-linux
      - libfreetype6
      - libpng16-16
      - libxrender1
      - libx11-6
      - libxext6
      - libxi6
      - libxtst6
      - libpsm-infinipath1
      - libboost-all-dev
      - libasound2
